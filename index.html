<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatehpur Hubs - Local Services</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDKs (v8 for stability) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Container for mobile simulation */
        #app-container {
            width: 100%;
            max-width: 420px;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header Style */
        #app-header {
            background-color: #2a5298; /* Dark Blue */
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .logout-btn {
            background-color: #ff4d4f; /* Red for emphasis */
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #d9363e;
        }

        /* Navigation Bar */
        #nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: #fff;
            border-top: 1px solid #eee;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        .nav-item {
            flex-grow: 1;
            text-align: center;
            padding: 10px 0;
            cursor: pointer;
            color: #777;
            font-size: 0.75rem;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #2a5298;
        }
        .nav-item i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        /* Main Content Area */
        #mainApp {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 60px; /* Space for fixed navbar */
        }
        .screen {
            display: none;
            padding: 15px;
            min-height: 100%;
        }
        .screen.active {
            display: block;
        }

        /* Registration Screen Style */
        #registrationScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
            height: 100vh;
        }
        #registrationScreen h2 {
            color: #2a5298;
            margin-bottom: 20px;
        }
        .input-group, #otpSection {
            width: 100%;
            margin-bottom: 15px;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .main-btn {
            background-color: #2a5298;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        .main-btn:hover {
            background-color: #1e3a66;
        }
        /* Message Area Style */
        #loginMsg {
            margin-top: 15px;
            font-weight: 600;
            padding: 10px;
            border-radius: 8px;
            min-height: 40px; /* Ensure space is reserved */
        }

        /* Home/List Styles */
        #mistri-categories {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            white-space: nowrap;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .cat-btn {
            padding: 8px 15px;
            margin-right: 10px;
            background-color: #e5e7eb;
            color: #333;
            border: none;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            flex-shrink: 0;
        }
        .cat-btn.selected {
            background-color: #2a5298;
            color: white;
            font-weight: bold;
        }

        /* Search Bar */
        #search-container {
            margin-bottom: 15px;
        }
        #main-search-bar {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        /* Profile Card */
        .profile-card {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #ffc107; /* Yellow border for Providers */
        }
        .profile-card h4 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
        }
        .profile-card p {
            margin: 0;
            font-size: 0.9rem;
        }
        .whatsapp-btn, .contact-btn, .share-btn {
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: opacity 0.2s;
        }
        .whatsapp-btn {
            background-color: #25d366;
            color: white;
        }
        .contact-btn {
            background-color: #007bff;
            color: white;
        }
        .share-btn {
            background-color: #9c27b0;
            color: white;
        }

        /* Promotion Ad Card (General Banner) */
        .ad-card {
            background-color: #e3f2fd; /* Light blue */
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px dashed #2a5298;
        }
        .ad-card button {
            background-color: #ff9800;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Adsterra Unit Style */
        .adsterra-card {
            background-color: #fff3e0; /* Light Orange */
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            border: 1px solid #ff9800;
        }

        /* Manual Promotion Style */
        .manual-promo-card {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Form Styles */
        .form-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        .form-container h3 {
            color: #2a5298;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .form-field {
            margin-bottom: 15px;
        }
        .form-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .form-field input, .form-field select, .form-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 0.95rem;
        }
        .submit-btn {
            background-color: #4caf50; /* Green submit button */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
        }

    </style>
</head>
<body>
    <div id="app-container">

        <!-- -------------------- LOGOUT AND AUTH SCREEN -------------------- -->
        <div id="registrationScreen" style="display: none;">
            <h2>Fatehpur Hubs: Services & Jobs</h2>
            <div id="loginMsg">‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</div>

            <div id="profileInputSection" class="input-group">
                <input type="text" id="userName" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ (Name)" required>
                <input type="text" id="userArea" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§è‡§∞‡§ø‡§Ø‡§æ/‡§Æ‡•ã‡§π‡§≤‡•ç‡§≤‡§æ (Area)" required style="margin-top: 10px;">
                <input type="number" id="phoneInput" placeholder="10 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞" maxlength="10" required style="margin-top: 10px;">
                <button id="sendOtpBtn" class="main-btn">Send OTP & Sign Up</button>
            </div>

            <div id="otpSection" class="input-group" style="display: none;">
                <input type="number" id="otpInput" placeholder="6 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ OTP" maxlength="6" required>
                <button id="verifyOtpBtn" class="main-btn">Verify OTP & Login</button>
            </div>
            
            <p style="font-size: 0.8rem; color: #777; margin-top: 20px;">Firebase Phone Authentication ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§‡•§</p>
            <div id="recaptcha-container"></div>
        </div>

        <!-- -------------------- MAIN APPLICATION UI -------------------- -->
        <div id="mainApp" style="display: none;">

            <!-- Header with Logout Button -->
            <header id="app-header">
                <div class="logo">Fatehpur Hubs</div>
                <button class="logout-btn" onclick="window.logOut()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </header>

            <!-- Main Content Screens -->
            <div id="mainAppContent">

                <!-- 1. HOME/MISTRI SCREEN -->
                <div id="home-screen" class="screen active">
                    <!-- TOP Ad Placeholder (General Banner) -->
                    <div id="ad-placeholder-top" class="ad-card" onclick="window.contactForAds()">
                        <p style="font-size: 1.1rem; font-weight: bold; color: #2a5298;">ü§ù ‡§Ö‡§™‡§®‡•á ‡§¨‡§ø‡§ú‡§º‡§®‡•á‡§∏ ‡§ï‡§æ Ad ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ó‡§µ‡§æ‡§è‡§Å! (Top Ad)</p>
                        <p style="font-size: 0.9rem; color: #555;">‡§Ö‡§™‡§®‡•á ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞‡•ç‡§∏ ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö‡•á‡§Ç‡•§</p>
                        <button>Contact for Ads</button>
                    </div>
                    
                    <!-- Adsterra Unit 1 (Top) -->
                    <div id="adsterra-unit-1"></div>
                    
                    <!-- Manual Promotion 1 (Top) -->
                    <div id="manual-promo-1"></div>

                    <!-- Search -->
                    <div id="search-container">
                        <input type="text" id="main-search-bar" placeholder="‡§∏‡•á‡§µ‡§æ ‡§Ø‡§æ ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." onkeyup="searchServices()">
                    </div>

                    <!-- Categories -->
                    <div id="mistri-categories">
                        <!-- Category buttons will be rendered here -->
                    </div>

                    <!-- Provider List (Middle Ads injected here) -->
                    <div id="mistri-list">
                        <!-- Services will be loaded here -->
                    </div>

                    <button id="load-more-providers" class="main-btn" style="display:none; margin-top: 15px;" onclick="loadCategories(true)">
                        Load More Services
                    </button>
                    
                    <!-- BOTTOM ADS SECTION (Outside the list loop) -->
                    
                    <!-- General Promotion Banner (Bottom) -->
                    <div id="ad-placeholder-bottom-section"></div>
                    
                    <!-- Adsterra Unit 3 (Bottom) -->
                    <div id="adsterra-unit-3"></div>
                    
                    <!-- Manual Promotion 3 & 4 (Bottom) -->
                    <div id="manual-promo-3"></div>
                    <div id="manual-promo-4"></div>

                </div>

                <!-- 2. SERVICE ADD SCREEN -->
                <div id="add-service-screen" class="screen">
                    <div class="form-container">
                        <h3>üîß ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§™‡•ç‡§∞‡•ã‡§µ‡§æ‡§á‡§°‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
                        <form id="serviceForm" onsubmit="return registerService()">
                            <div class="form-field">
                                <label for="providerName">‡§®‡§æ‡§Æ</label>
                                <input type="text" id="providerName" required>
                            </div>
                            <div class="form-field">
                                <label for="providerPhone">‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)</label>
                                <input type="number" id="providerPhone" maxlength="10" required>
                            </div>
                            <div class="form-field">
                                <label for="serviceCategory">‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</label>
                                <select id="serviceCategory" required>
                                    <option value="">-- ‡§ö‡•Å‡§®‡•á‡§Ç --</option>
                                    <option value="Plumber">‡§™‡•ç‡§≤‡§Æ‡•ç‡§¨‡§∞ (Plumber)</option>
                                    <option value="Electrician">‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•Ä‡§∂‡§ø‡§Ø‡§® (Electrician)</option>
                                    <option value="Carpenter">‡§¨‡§¢‡§º‡§à (Carpenter)</option>
                                    <option value="Mason">‡§Æ‡§ø‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä (Mason)</option>
                                    <option value="Painter">‡§™‡•á‡§Ç‡§ü‡§∞ (Painter)</option>
                                    <option value="AC Mechanic">AC ‡§Æ‡•à‡§ï‡•á‡§®‡§ø‡§ï</option>
                                    <option value="Tiler">‡§ü‡§æ‡§á‡§≤‡§∞ (Tiler)</option>
                                    <option value="Beautician">‡§¨‡•ç‡§Ø‡•Ç‡§ü‡•Ä‡§∂‡§ø‡§Ø‡§®</option>
                                    <option value="Home Cleaning">‡§π‡•ã‡§Æ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§Ç‡§ó</option>
                                    <option value="Security Guard">‡§∏‡§ø‡§ï‡•ç‡§Ø‡•ã‡§∞‡§ø‡§ü‡•Ä ‡§ó‡§æ‡§∞‡•ç‡§°</option>
                                    <option value="Laundry Service">‡§≤‡•â‡§®‡•ç‡§°‡•ç‡§∞‡•Ä ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏</option>
                                    <option value="Legal Consultant">‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞</option>
                                    <option value="Private Teacher">‡§™‡•ç‡§∞‡§æ‡§á‡§µ‡•á‡§ü ‡§ü‡•Ä‡§ö‡§∞</option>
                                    <option value="Computer Repair">‡§ï‡§Ç‡§™‡•ç‡§Ø‡•Ç‡§ü‡§∞/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§∞‡§ø‡§™‡•á‡§Ø‡§∞</option>
                                    <option value="Welder">‡§µ‡•á‡§≤‡•ç‡§°‡§∞</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label for="providerArea">‡§è‡§∞‡§ø‡§Ø‡§æ/‡§Æ‡•ã‡§π‡§≤‡•ç‡§≤‡§æ</label>
                                <input type="text" id="providerArea" required>
                            </div>
                            <div class="form-field">
                                <label for="providerExperience">‡§Ö‡§®‡•Å‡§≠‡§µ (‡§∏‡§æ‡§≤‡•ã‡§Ç ‡§Æ‡•á‡§Ç)</label>
                                <input type="number" id="providerExperience" required min="0">
                            </div>
                            <button type="submit" class="submit-btn">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                        </form>
                    </div>
                </div>

                <!-- 3. JOB SCREEN (Pending implementation details for loadJobs) -->
                <div id="jobs-screen" class="screen">
                    <div class="form-container">
                        <h3>üíº ‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</h3>
                        <form id="jobForm" onsubmit="return jobRegister()">
                            <div class="form-field">
                                <label for="jobTitle">‡§ú‡•â‡§¨ ‡§ü‡§æ‡§á‡§ü‡§≤ (‡§ú‡•à‡§∏‡•á: ‡§∏‡•á‡§≤‡•ç‡§∏‡§Æ‡•à‡§®)</label>
                                <input type="text" id="jobTitle" required>
                            </div>
                            <div class="form-field">
                                <label for="jobShopName">‡§¶‡•Å‡§ï‡§æ‡§®/‡§ï‡§Ç‡§™‡§®‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
                                <input type="text" id="jobShopName" required>
                            </div>
                            <div class="form-field">
                                <label for="jobLocation">‡§ú‡•â‡§¨ ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</label>
                                <input type="text" id="jobLocation" required>
                            </div>
                            <div class="form-field">
                                <label for="jobSalary">‡§∏‡•à‡§≤‡§∞‡•Ä/‡§µ‡•á‡§§‡§®</label>
                                <input type="number" id="jobSalary" required min="1000">
                            </div>
                             <div class="form-field">
                                <label for="jobPhone">‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ (10 ‡§Ö‡§Ç‡§ï)</label>
                                <input type="number" id="jobPhone" maxlength="10" required>
                            </div>
                            <div class="form-field">
                                <label for="jobDescription">‡§ú‡•â‡§¨ ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ (Details)</label>
                                <textarea id="jobDescription" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="submit-btn" style="background-color: #ff9800;">‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
                        </form>
                    </div>

                    <h3 style="color: #2a5298;">üåü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡•å‡§ï‡§∞‡§ø‡§Ø‡§æ‡§Å</h3>
                    <div id="job-list">
                         <p style="text-align:center; color:#555;">‡§ú‡•â‡§¨ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡•ã‡§° ‡§π‡•ã‡§Ç‡§ó‡•Ä‡•§</p>
                    </div>
                </div>

                <!-- 4. SHARE SCREEN -->
                <div id="share-screen" class="screen">
                    <div class="ad-card" style="margin-top: 30px; padding: 40px;">
                        <i class="fas fa-share-alt" style="font-size: 3rem; color: #2a5298; margin-bottom: 15px;"></i>
                        <h3 style="color: #2a5298; margin-bottom: 10px;">Fatehpur Hubs ‡§ï‡•ã ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç!</h3>
                        <p>‡§Ø‡§π ‡§ê‡§™ ‡§´‡§§‡•á‡§π‡§™‡•Å‡§∞ ‡§ï‡•á ‡§≤‡•ã‡§ó‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏‡•á ‡§Ö‡§™‡§®‡•á ‡§¶‡•ã‡§∏‡•ç‡§§‡•ã‡§Ç ‡§î‡§∞ ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§</p>
                        <button onclick="window.shareApp()" class="main-btn" style="background-color: #00bcd4;">
                            <i class="fas fa-paper-plane"></i> ‡§Ö‡§≠‡•Ä ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç
                        </button>
                    </div>
                </div>

            </div>

            <!-- Navigation Bar -->
            <div id="nav-bar">
                <div class="nav-item active" onclick="showScreen('home-screen')">
                    <i class="fas fa-home"></i> ‡§π‡•ã‡§Æ
                </div>
                <div class="nav-item" onclick="showScreen('add-service-screen')">
                    <i class="fas fa-tools"></i> ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç
                </div>
                <div class="nav-item" onclick="showScreen('jobs-screen')">
                    <i class="fas fa-briefcase"></i> ‡§®‡•å‡§ï‡§∞‡§ø‡§Ø‡§æ‡§Å
                </div>
                <div class="nav-item" onclick="showScreen('share-screen')">
                    <i class="fas fa-share-alt"></i> ‡§∂‡•á‡§Ø‡§∞
                </div>
            </div>

        </div>
    </div>


    <script>
    // ----------------------------------------------------------------------
    // üî• CRITICAL FIX: Firebase Configuration and Environment Check
    // ----------------------------------------------------------------------
    let firebaseConfig = {
        // User's hardcoded config as a robust fallback
        apiKey: "AIzaSyA37JsLUIG-kypZ55vdpLTp3WKHgRH2IwN",
        authDomain: "fatehpur-hubs-a3a9f.firebaseapp.com",
        databaseURL: "https://fatehpur-hubs-a3a9f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fatehpur-hubs-a3a9f",
        storageBucket: "fatehpur-hubs-a3a9f.appspot.com",
        messagingSenderId: "294360741451",
        appId: "1:294360741451:web:3bc85078805750b9fabfce"
    };

    if (typeof __firebase_config !== 'undefined') {
        try {
            // Overwrite with environment config
            firebaseConfig = JSON.parse(__firebase_config);
            console.log("Using environment Firebase configuration.");
        } catch (e) {
            console.error("Error parsing __firebase_config, falling back to hardcoded config.", e);
        }
    }
    // ----------------------------------------------------------------------
    
    let recaptchaVerifier, confirmationResult;
    let tempUserData = {}; 
    
    // ‚≠ê GLOBAL STATE AND LIMITS ‚≠ê
    const providersLimit = 20; 
    let providersLastTimestamp = null; 
    let providersLastKey = null; 
    let currentCategory = null; 
    
    // ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≤‡•ã‡§ï‡§≤ ‡§ê‡§∞‡•á ‡§î‡§∞ ‡§™‡•á‡§ú ‡§á‡§Ç‡§°‡•á‡§ï‡•ç‡§∏
    let filteredProviders = [];
    let filteredPageIndex = 0;
    
    const jobsLimit = 10;
    
    // --- Message Utility (REPLACING ALL ALERTS) ---
    /**
     * Shows a non-blocking message to the user in the designated area.
     * @param {string} message - The message content.
     * @param {string} type - 'info', 'success', 'error', 'warning'.
     * @param {number} duration - How long to show the message (ms).
     */
    function displayMessage(message, type = 'info', duration = 5000) {
        const msgElement = document.getElementById('loginMsg');
        if (!msgElement) return;

        let color = '#2a5298'; // info
        if (type === 'success') color = 'green';
        if (type === 'error') color = 'red';
        if (type === 'warning') color = 'orange';

        msgElement.style.display = 'block';
        msgElement.style.padding = '10px';
        msgElement.style.border = `1px solid ${color}`;
        msgElement.innerHTML = `<span style='color:${color}; font-weight: bold;'>${message}</span>`;
        
        // Clear the message after the duration
        setTimeout(() => {
            msgElement.innerHTML = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç'; // Revert back to original message
            msgElement.style.padding = '0';
            msgElement.style.border = 'none';
        }, duration);
    }
    window.displayMessage = displayMessage; // Expose globally for convenience
    // --- END Message Utility ---

    // --- AD MOCK FUNCTIONS (New & Updated) ---
    
    // 1. General Promo Banner
    function renderAdCard(id, title = "‡§Ö‡§™‡§®‡•á ‡§¨‡§ø‡§ú‡§º‡§®‡•á‡§∏ ‡§ï‡§æ Ad ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ó‡§µ‡§æ‡§è‡§Å!") {
        return `<div id="${id}" class="ad-card" onclick="window.contactForAds()">
            <p style="font-size: 1.1rem; font-weight: bold; color: #2a5298;">ü§ù ${title}</p>
            <p style="font-size: 0.9rem; color: #555;">‡§Ö‡§™‡§®‡•á ‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞‡•ç‡§∏ ‡§§‡§ï ‡§™‡§π‡•Å‡§Å‡§ö‡•á‡§Ç‡•§</p>
            <button>Contact for Ads</button>
        </div>`;
    }

    // 2. Adsterra Units (Placeholder for JS Injection)
    function renderAdsterraUnit(id, type = "Standard Banner") {
        return `<div id="${id}" class="adsterra-card">
            <p style="font-weight: bold; color: #ff9800;">üì¢ Adsterra Unit: ${type}</p>
            <p style="font-size: 0.8rem; color: #777;">(Content Injected by Adsterra JS)</p>
            <div style="height: 60px; background-color: #ffe0b2; border-radius: 6px; margin-top: 5px; border: 1px dashed #ffb74d;"></div>
        </div>`;
    }
    
    // 3. Manual Promotions 
    function getManualPromotions() {
        return [
            { id: 'manual-promo-1', title: 'ü•á Fatehpur\'s Top Shop', subtitle: '‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•â‡§®‡§ø‡§ï‡•ç‡§∏ ‡§™‡§∞ 50% ‡§ï‡•Ä ‡§õ‡•Ç‡§ü ‡§™‡§æ‡§è‡§Ç! ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§ï‡§∞‡•á‡§Ç!', linkText: 'View Deal', linkUrl: '#topshop', color: '#ff5722' },
            { id: 'manual-promo-2', title: 'üöó Cab Service in Town', subtitle: '‡§≤‡•ã‡§ï‡§≤ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§™‡§∞ ‚Çπ50 ‡§ë‡§´‡•§ ‡§Ö‡§≠‡•Ä ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§', linkText: 'Book Now', linkUrl: '#cab', color: '#00bcd4' },
            { id: 'manual-promo-3', title: 'üè° Property Deals', subtitle: 'Fatehpur ‡§Æ‡•á‡§Ç ‡§∏‡§¨‡§∏‡•á ‡§∏‡§∏‡•ç‡§§‡•á ‡§™‡•ç‡§≤‡•â‡§ü ‡§î‡§∞ ‡§Æ‡§ï‡§æ‡§®‡•§', linkText: 'Contact Agent', linkUrl: '#property', color: '#4caf50' },
            { id: 'manual-promo-4', title: 'üè• Health Checkup Offer', subtitle: '‡§™‡•Ç‡§∞‡•á ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§´‡•ç‡§∞‡•Ä ‡§¨‡•ç‡§≤‡§° ‡§ü‡•á‡§∏‡•ç‡§ü‡•§', linkText: 'Register', linkUrl: '#health', color: '#9c27b0' }
        ];
    }
    
    function renderManualPromotion(promo) {
        return `<div id="${promo.id}" class="manual-promo-card" style="border-left: 5px solid ${promo.color}; background-color: ${promo.color}11;">
            <h5 style="color: ${promo.color}; font-weight: bold; margin: 0 0 5px 0;">${promo.title}</h5>
            <p style="font-size: 0.9rem; margin: 0 0 10px 0;">${promo.subtitle}</p>
            <button style="background-color: ${promo.color}; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem;"
                    onclick="window.open('${promo.linkUrl}', '_blank')">${promo.linkText}</button>
        </div>`;
    }
    // --- END AD MOCK FUNCTIONS ---
    
    // --- JOB LOAD FUNCTION ---
    window.loadJobs = () => {
        const listElement = document.getElementById('job-list');
        listElement.innerHTML = `<p style="text-align:center;color:#2a5298;">‡§®‡•å‡§ï‡§∞‡§ø‡§Ø‡§æ‡§Å ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç...</p>`;

        if (!window.jobsRef) return; 

        window.jobsRef.limitToLast(jobsLimit).once('value', (snapshot) => {
            if (!snapshot.exists()) {
                listElement.innerHTML = '<p style="text-align:center;color:#ff6666;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§®‡•å‡§ï‡§∞‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>';
                return;
            }
            
            let allJobs = [];
            snapshot.forEach(childSnapshot => {
                allJobs.push(childSnapshot.val());
            });

            allJobs.reverse(); 
            
            const htmlContent = allJobs.map(job => renderJobCard(job)).join('');
            listElement.innerHTML = htmlContent;

        }, (error) => {
            console.error("Error loading jobs:", error);
            listElement.innerHTML = '<p style="text-align:center;color:red;">‡§ú‡•â‡§¨‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§</p>';
            displayMessage("‡§ú‡•â‡§¨‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§", 'error');
        });
    }
    // --- END JOB LOAD FUNCTION ---

    // ‡§∂‡•á‡§Ø‡§∞ ‡§°‡•Ä‡§ü‡•á‡§≤‡•ç‡§∏ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    window.shareProviderDetails = (name, phone, category) => {
        const shareText = `‡§®‡§æ‡§Æ: ${name} (${category})\n‡§´‡§º‡•ã‡§®: ${phone}\n\nFatehpur Hubs App ‡§ï‡•á ‡§ú‡§º‡§∞‡§ø‡§è ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§™‡•ç‡§∞‡•ã‡§µ‡§æ‡§á‡§°‡§∞ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§Æ‡§ø‡§≤‡•Ä‡•§`;
        if (navigator.share) {
            navigator.share({
                title: 'Service Provider Contact',
                text: shareText
            }).catch(error => console.error('Sharing failed', error));
        } else {
            // FIX: Using displayMessage instead of complex alert replacement
            displayMessage(`‡§∂‡•á‡§Ø‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§§‡•à‡§Ø‡§æ‡§∞: ${shareText.replace(/\n/g, ' / ')}`, 'info', 7000);
        }
    }

    // ‡§™‡•ç‡§∞‡•ã‡§µ‡§æ‡§á‡§°‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
    function renderProviderCard(p) {
        return `<div class="profile-card">
            <h4 style="color:#2a5298;">${p.name} - (${p.category})</h4>
            <p style="font-size:12px;color:#555;">üìç ${p.area} | Experience: ${p.experience}</p>
            <div style="margin-top:10px; display: flex; justify-content: space-between; gap: 5px;">
                <button class="whatsapp-btn flex-1" onclick="openWhatsApp('${p.phone}')">WhatsApp</button>
                <button class="contact-btn flex-1" onclick="window.location.href='tel:${p.phone}'">Call Now</button>
                <button class="share-btn flex-1" onclick="shareProviderDetails('${p.name}', '${p.phone}', '${p.category}')">Share</button>
            </div>
        </div>`;
    }

    // ‡§ú‡•â‡§¨ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
    function renderJobCard(job) {
        return `<div class="profile-card" style="border-left: 5px solid #ff9800;">
            <h4 style="color:#ff9800;">${job.title} (${job.shopName})</h4>
            <p style="font-size:12px;color:#555;margin-bottom:5px;">üí∞ Salary: ‚Çπ${job.salary} | üìç ${job.location}</p>
            <p style="font-size:14px;margin-bottom:10px;">${job.description.substring(0, 100)}...</p>
            <button class="whatsapp-btn" onclick="openWhatsApp('${job.phone}')">Apply/WhatsApp</button>
        </div>`;
    }

    // ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§¨‡§ü‡§® ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç
    function renderCategoryButtons() {
        const categoriesDiv = document.getElementById('mistri-categories');
        const allCategories = [
            'Plumber', 'Electrician', 'Carpenter', 'Mason', 'Painter', 
            'AC Mechanic', 'Tiler', 'Beautician', 'Home Cleaning', 'Security Guard', 
            'Laundry Service', 'Legal Consultant', 'Private Teacher', 'Computer Repair', 'Welder'
        ];
        
        categoriesDiv.innerHTML = allCategories.map(cat => 
            `<button class="cat-btn" onclick="filterByCategory('${cat}')">${cat}</button>`
        ).join('');
    }

    // ‚≠ê 1. loadCategories - ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§™‡•à‡§ú‡§ø‡§®‡•á‡§∂‡§® (Ads injected)
    window.loadCategories = (loadMore = false) => {
        const listElement = document.getElementById('mistri-list');
        const loadMoreBtn = document.getElementById('load-more-providers');
        const manualPromos = getManualPromotions(); 
        
        let queryRef;
        loadMoreBtn.style.display = 'none';
        
        if (!window.providersRef) return; 

        if (currentCategory !== null) {
            currentCategory = null; 
            filteredProviders = [];
            filteredPageIndex = 0;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('selected'));
        }

        const baseRef = window.providersRef.orderByChild('timestamp');

        if (!loadMore) {
            providersLastTimestamp = null;
            providersLastKey = null;
            
            // Render Top Ads (Outside the list loop)
            document.getElementById('adsterra-unit-1').innerHTML = renderAdsterraUnit('adsterra-top', 'Top Adsterra');
            document.getElementById('manual-promo-1').innerHTML = renderManualPromotion(manualPromos[0]);
            
            // Clear Bottom Ad placeholders for now
            document.getElementById('ad-placeholder-bottom-section').innerHTML = '';
            document.getElementById('adsterra-unit-3').innerHTML = '';
            document.getElementById('manual-promo-3').innerHTML = '';
            document.getElementById('manual-promo-4').innerHTML = '';

            listElement.innerHTML = `<h3>Available Services (Top ${providersLimit})</h3><p style="text-align:center;color:#2a5298;">‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ${providersLimit} ‡§™‡•ç‡§∞‡•ã‡§µ‡§æ‡§á‡§°‡§∞‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</p>`;
            
            queryRef = baseRef.limitToLast(providersLimit + 1); 
        } else {
            listElement.insertAdjacentHTML('beforeend', '<p id="loading-more" style="text-align:center;color:#2a5298;">‡§î‡§∞ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>');
            
            queryRef = baseRef.endBefore(providersLastTimestamp, providersLastKey).limitToLast(providersLimit + 1);
        }

        queryRef.once('value', (snapshot) => {
            document.getElementById('loading-more')?.remove();

            if (!loadMore && !snapshot.exists()) {
                listElement.innerHTML = '<h3>Available Services</h3><p style="text-align:center;color:#ff6666;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!</p>';
                return;
            }

            let allItems = [];
            let snapshotSize = 0; 
            
            snapshot.forEach(childSnapshot => {
                allItems.push({ 
                    key: childSnapshot.key, 
                    data: childSnapshot.val() 
                });
                snapshotSize++; 
            });

            allItems.reverse();
            
            if (loadMore && allItems.length > 0) {
                allItems.shift(); 
            }
            
            let itemsToRender = allItems.slice(0, providersLimit);
            
            if (itemsToRender.length > 0) {
                providersLastTimestamp = itemsToRender[itemsToRender.length - 1].data.timestamp;
                providersLastKey = itemsToRender[itemsToRender.length - 1].key;
            } 
            
            // --- AD INJECTION LOGIC (Middle Ads) ---
            let contentArray = [];
            for (let i = 0; i < itemsToRender.length; i++) {
                contentArray.push(renderProviderCard(itemsToRender[i].data));
                
                // Inject Middle Ads after 5 items on the initial load
                if (i === 4 && !loadMore) {
                    contentArray.push(renderAdCard('ad-placeholder-middle', 'üåü ‡§Ü‡§™‡§ï‡•á ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§¨‡§∏‡•á ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ ‡§ë‡§´‡§º‡§∞! (General Middle Ad)'));
                    contentArray.push(renderAdsterraUnit('adsterra-middle', 'Middle Adsterra'));
                    contentArray.push(renderManualPromotion(manualPromos[1])); // Manual Promo 2
                }
            }

            const htmlContent = contentArray.join('');
            
            if (!loadMore) {
                listElement.innerHTML = `<h3>Available Services (${itemsToRender.length} loaded)</h3>` + htmlContent;
                
                // --- AD INJECTION LOGIC (Bottom Ads, on initial load) ---
                if (itemsToRender.length > 0) {
                    // General Promo Banner (Bottom)
                    document.getElementById('ad-placeholder-bottom-section').innerHTML = renderAdCard('ad-placeholder-bottom', '‚¨áÔ∏è ‡§´‡§§‡•á‡§π‡§™‡•Å‡§∞ ‡§ï‡•á ‡§ü‡•â‡§™ ‡§°‡•Ä‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡•á‡§ñ‡•á‡§Ç ‚¨áÔ∏è (General Bottom Ad)');
                    // Adsterra Unit 3 (Bottom)
                    document.getElementById('adsterra-unit-3').innerHTML = renderAdsterraUnit('adsterra-bottom', 'Bottom Adsterra');
                    // Manual Promotion 3 & 4
                    document.getElementById('manual-promo-3').innerHTML = renderManualPromotion(manualPromos[2]);
                    document.getElementById('manual-promo-4').innerHTML = renderManualPromotion(manualPromos[3]);
                }
                // --- END AD INJECTION LOGIC (Bottom Ads) ---
            } else {
                listElement.insertAdjacentHTML('beforeend', htmlContent);
            }
            // --- END AD INJECTION LOGIC (Middle Ads) ---

            if (snapshotSize > providersLimit) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = () => loadCategories(true);
            } else {
                loadMoreBtn.style.display = 'none';
                listElement.insertAdjacentHTML('beforeend', '<p style="text-align:center;color:green;font-weight:bold;">‚úÖ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§ ‡§Ö‡§¨ ‡§î‡§∞ ‡§ï‡•ã‡§à ‡§®‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!</p>');
            }

        }, (error) => {
            console.error("Error loading services:", error);
            document.getElementById('loading-more')?.remove();
            listElement.innerHTML = '<h3>Available Services</h3><p style="text-align:center;color:red;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§</p>';
            displayMessage("‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏‡•á‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§", 'error');
        });
    }

    // ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞‡•ç‡§° ‡§≤‡•ã‡§ï‡§≤ ‡§ê‡§∞‡•á ‡§∏‡•á ‡§™‡•á‡§ú ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡•á‡§Ç (Ads injected)
    function renderFilteredPage(listElement, loadMoreBtn, isLoadMore = false) {
        const manualPromos = getManualPromotions();
        const start = filteredPageIndex * providersLimit;
        const end = start + providersLimit;
        const itemsToRender = filteredProviders.slice(start, end);
        const totalItems = filteredProviders.length;
        const isLastPage = totalItems <= end;


        if (itemsToRender.length > 0) {
            
            // --- AD INJECTION LOGIC (Filtered List - Middle Ads) ---
            let contentArray = [];
            for(let i=0; i < itemsToRender.length; i++){
                contentArray.push(renderProviderCard(itemsToRender[i]));
                // Inject Middle Ads only on the very first page of the filtered list, after 5 items.
                if(start === 0 && i === 4 && itemsToRender.length > 5 && !isLoadMore){
                     contentArray.push(renderAdCard('filter-ad-middle', 'üåü ‡§Ü‡§™‡§ï‡•á ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§¨‡§∏‡•á ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ ‡§ë‡§´‡§º‡§∞! (Filtered General Ad)'));
                     contentArray.push(renderAdsterraUnit('adsterra-filter-middle', 'Filtered Middle Adsterra'));
                     contentArray.push(renderManualPromotion(manualPromos[1])); // Manual Promo 2
                }
            }
            const htmlContent = contentArray.join('');
            // --- END AD INJECTION LOGIC ---
            
            if (!isLoadMore) {
                listElement.innerHTML = `<h3>Available Services (${currentCategory} - ${Math.min(end, totalItems)}/${totalItems} loaded)</h3>` + htmlContent;
                
                // Clear Bottom Ad placeholders if filtering starts
                document.getElementById('ad-placeholder-bottom-section').innerHTML = '';
                document.getElementById('adsterra-unit-3').innerHTML = '';
                document.getElementById('manual-promo-3').innerHTML = '';
                document.getElementById('manual-promo-4').innerHTML = '';
            } else {
                listElement.insertAdjacentHTML('beforeend', htmlContent);
            }
            filteredPageIndex++; 
        } else if (!isLoadMore) {
             listElement.innerHTML = `<h3>Available Services (${currentCategory})</h3><p style="text-align:center;color:#ff6666;">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!</p>`;
        }
        
        if (totalItems > filteredPageIndex * providersLimit) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.onclick = () => filterByCategory(currentCategory, true);
        } else {
            loadMoreBtn.style.display = 'none';
            listElement.insertAdjacentHTML('beforeend', '<p style="text-align:center;color:green;font-weight:bold;">‚úÖ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡•§</p>');
            
            // Inject Bottom Ads on the last page of the filtered list
            if(totalItems > 0 && isLastPage) {
                 // General Promo Banner (Bottom)
                document.getElementById('ad-placeholder-bottom-section').innerHTML = renderAdCard('filter-ad-bottom', '‚¨áÔ∏è ‡§´‡§§‡•á‡§π‡§™‡•Å‡§∞ ‡§ï‡•á ‡§ü‡•â‡§™ ‡§°‡•Ä‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡•á‡§ñ‡•á‡§Ç ‚¨áÔ∏è (Filtered General Bottom Ad)');
                // Adsterra Unit 3 (Bottom)
                document.getElementById('adsterra-unit-3').innerHTML = renderAdsterraUnit('adsterra-filter-bottom', 'Filtered Bottom Adsterra');
                // Manual Promotion 3 & 4
                document.getElementById('manual-promo-3').innerHTML = renderManualPromotion(manualPromos[2]);
                document.getElementById('manual-promo-4').innerHTML = renderManualPromotion(manualPromos[3]);
            }
        }
    }

    // ‚≠ê 2. ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç 
    window.filterByCategory = (category, loadMore = false) => {
        const listElement = document.getElementById('mistri-list');
        const loadMoreBtn = document.getElementById('load-more-providers');
        loadMoreBtn.style.display = 'none';
        
        providersLastTimestamp = null;
        providersLastKey = null;

        if (!window.providersRef) return; 
        
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.classList.remove('selected');
            if(btn.innerText === category) {
                btn.classList.add('selected');
            }
        });

        if (!loadMore) {
            currentCategory = category;
            filteredPageIndex = 0;
            
            // Render Top Ads again when filter is applied (ensures visibility)
            const manualPromos = getManualPromotions();
            document.getElementById('adsterra-unit-1').innerHTML = renderAdsterraUnit('adsterra-top', 'Top Adsterra');
            document.getElementById('manual-promo-1').innerHTML = renderManualPromotion(manualPromos[0]);
            
            listElement.innerHTML = `<h3>Available Services (${category})</h3><p style="text-align:center;color:#2a5298;">${category} ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à... (‡§™‡•Ç‡§∞‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§´‡•á‡§ö ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à)</p>`;

            window.providersRef.orderByChild('category').equalTo(category).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    listElement.innerHTML = `<h3>Available Services (${category})</h3><p style="text-align:center;color:#ff6666;">‡§á‡§∏ ‡§ï‡•à‡§ü‡•á‡§ó‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§ï‡•ã‡§à ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</p>`;
                    return;
                }

                filteredProviders = [];
                snapshot.forEach(childSnapshot => {
                    filteredProviders.push(childSnapshot.val());
                });

                filteredProviders.sort((a, b) => b.timestamp - a.timestamp);

                renderFilteredPage(listElement, loadMoreBtn);
            }, (error) => {
                console.error("Error loading filtered services:", error);
                listElement.innerHTML = '<p style="text-align:center;color:red;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§</p>';
                displayMessage("‡§´‡§ø‡§≤‡•ç‡§ü‡§∞‡•ç‡§° ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§", 'error');
            });

        } else {
            listElement.insertAdjacentHTML('beforeend', '<p id="loading-more" style="text-align:center;color:#2a5298;">‡§î‡§∞ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</p>');
            
            setTimeout(() => { 
                document.getElementById('loading-more')?.remove();
                renderFilteredPage(listElement, loadMoreBtn, true);
            }, 100);
        }
    };


    // ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§∞‡•ç‡§ö 
    window.searchServices = () => {
        const searchTerm = document.getElementById('main-search-bar').value.toLowerCase().trim();
        const listElement = document.getElementById('mistri-list');
        const manualPromos = getManualPromotions();

        if (!window.providersRef) return; 
        
        if (searchTerm.length < 3) {
            loadCategories(); 
            return;
        }

        listElement.innerHTML = `<h3>Search Results for "${searchTerm}"</h3><p style="text-align:center;color:#2a5298;">‡§ñ‡•ã‡§ú ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>`;
        document.getElementById('load-more-providers').style.display = 'none'; 
        
        // Render Top Ads
        document.getElementById('adsterra-unit-1').innerHTML = renderAdsterraUnit('adsterra-top', 'Top Adsterra');
        document.getElementById('manual-promo-1').innerHTML = renderManualPromotion(manualPromos[0]);
        // Clear Bottom Ad placeholders
        document.getElementById('ad-placeholder-bottom-section').innerHTML = '';
        document.getElementById('adsterra-unit-3').innerHTML = '';
        document.getElementById('manual-promo-3').innerHTML = '';
        document.getElementById('manual-promo-4').innerHTML = '';
        
        window.providersRef.once('value', (snapshot) => { 
            const providers = snapshot.val();
            let results = [];
            if (providers) {
                results = Object.values(providers).filter(p => 
                    (p.name && p.name.toLowerCase().includes(searchTerm)) || 
                    (p.category && p.category.toLowerCase().includes(searchTerm)) ||
                    (p.area && p.area.toLowerCase().includes(searchTerm))
                );
                
                results.sort((a, b) => b.timestamp - a.timestamp);
            }
            
            // --- AD INJECTION LOGIC (Search Results) ---
            let contentArray = [];
            for (let i = 0; i < results.length; i++) {
                contentArray.push(renderProviderCard(results[i]));
                if (i === 4 && results.length > 5) { // Inject middle ads after 5th item
                    contentArray.push(renderAdCard('search-ad-middle', 'üåü ‡§Ü‡§™‡§ï‡•á ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§æ ‡§∏‡§¨‡§∏‡•á ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ ‡§ë‡§´‡§º‡§∞! (Search General Ad)'));
                    contentArray.push(renderAdsterraUnit('adsterra-search-middle', 'Search Middle Adsterra'));
                    contentArray.push(renderManualPromotion(manualPromos[1])); // Manual Promo 2
                }
            }
            
            let html = `<h3>Search Results for "${searchTerm}" (${results.length} found)</h3>`;
            if (results.length > 0) {
                html += contentArray.join('');
                // Inject bottom ads
                document.getElementById('ad-placeholder-bottom-section').innerHTML = renderAdCard('search-ad-bottom', '‚¨áÔ∏è ‡§´‡§§‡•á‡§π‡§™‡•Å‡§∞ ‡§ï‡•á ‡§ü‡•â‡§™ ‡§°‡•Ä‡§≤‡•ç‡§∏ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡•á‡§ñ‡•á‡§Ç ‚¨áÔ∏è (Search General Bottom Ad)');
                document.getElementById('adsterra-unit-3').innerHTML = renderAdsterraUnit('adsterra-search-bottom', 'Search Bottom Adsterra');
                document.getElementById('manual-promo-3').innerHTML = renderManualPromotion(manualPromos[2]);
                document.getElementById('manual-promo-4').innerHTML = renderManualPromotion(manualPromos[3]);
            } else {
                html += '<p style="text-align:center;color:#ff6666;">‡§Ü‡§™‡§ï‡•Ä ‡§ñ‡•ã‡§ú ‡§∏‡•á ‡§Æ‡•á‡§≤ ‡§ñ‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§ï‡•ã‡§à ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§</p>';
            }
            listElement.innerHTML = html;
            // --- END AD INJECTION LOGIC ---
        });
    };
    
    // ‡§≤‡•â‡§ó ‡§Ü‡§â‡§ü ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    window.logOut = () => {
        firebase.auth().signOut().then(() => {
            console.log("User signed out successfully.");
            location.reload(); 
        }).catch((error) => {
            console.error("Sign Out Error:", error);
            displayMessage("Sign Out ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§", 'error');
        });
    }

    // ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§≤‡§ø‡§∏‡§®‡§∞ ‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    window.startFirebaseListener = () => {
        loadCategories(); 
        renderCategoryButtons(); 
    }

    // WHATSAPP ‡§¨‡§ü‡§® ‡§´‡§º‡§ø‡§ï‡•ç‡§∏
    function openWhatsApp(phone) {
        let num = phone.toString().replace(/[^0-9]/g, '');
        if (num.length === 10) num = '91' + num;
        if (num.length === 12 && num.startsWith('91')) {
        } else if (num.length === 13 && num.startsWith('919')) {
            num = num.substring(1);
        }
        window.open('https://wa.me/' + num, '_blank');
    }

    // ‚≠ê 3. ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü ‡§´‡§º‡•ã‡§® ‡§ö‡•á‡§ï ‡§∂‡§æ‡§Æ‡§ø‡§≤)
    function registerService() {
        const name = document.getElementById('providerName').value;
        const phone = document.getElementById('providerPhone').value;
        const category = document.getElementById('serviceCategory').value;
        const area = document.getElementById('providerArea').value;
        const experience = document.getElementById('providerExperience').value;
        const form = document.getElementById('serviceForm');
        
        if (!window.providersRef) return false;

        if (!name || !phone || !category || !area || !experience) {
            displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç‡•§", 'warning');
            return false;
        }
        
        if (phone.length !== 10 || isNaN(phone)) {
            displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ 10 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ ‡§µ‡•à‡§ß ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", 'warning');
            return false;
        }
        
        // ‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§æ‡§Å‡§ö ‡§ï‡§∞‡•á‡§Ç
        window.providersRef.orderByChild('phone').equalTo(phone).once('value', (snapshot) => {
            if (snapshot.exists()) {
                console.error("‚ùå This phone number is already registered.");
                displayMessage("‚ùå ‡§Ø‡§π ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à‡•§ ‡§°‡•Å‡§™‡•ç‡§≤‡•Ä‡§ï‡•á‡§ü ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", 'error', 7000);
                return;
            }

            // ‡§Ø‡§¶‡§ø ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§Ø‡•Ç‡§®‡•Ä‡§ï ‡§π‡•à, ‡§§‡•ã ‡§°‡•á‡§ü‡§æ ‡§™‡•Å‡§∂ ‡§ï‡§∞‡•á‡§Ç
            const providerData = {
                name: name, phone: phone, category: category, area: area,
                experience: experience + ' years',
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };

            window.providersRef.push(providerData)
                .then(() => {
                    displayMessage("‚úÖ ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à! ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§", 'success');
                    form.reset(); 
                    loadCategories(); 
                })
                .catch((error) => {
                    displayMessage("‚ùå ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à: " + error.message, 'error', 7000);
                    console.error("Firebase Error:", error);
                });
        });
        
        return false; 
    }
    // ‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ‡§ï‡§æ ‡§Ö‡§Ç‡§§

    // ‡§ú‡•â‡§¨ ‡§™‡•ã‡§∏‡•ç‡§ü ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    function jobRegister() {
        const title = document.getElementById('jobTitle').value;
        const shopName = document.getElementById('jobShopName').value;
        const location = document.getElementById('jobLocation').value;
        const salary = document.getElementById('jobSalary').value;
        const description = document.getElementById('jobDescription').value;
        const phone = document.getElementById('jobPhone').value;
        const form = document.getElementById('jobForm');
        
        if (!window.jobsRef) return false;

        if (!title || !shopName || !location || !salary || !description || !phone) {
            displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡•â‡§¨ ‡§ï‡•á ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç‡•§", 'warning');
            return false;
        }

        if (phone.length !== 10 || isNaN(phone)) {
            displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ú‡•â‡§¨ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡•á ‡§≤‡§ø‡§è 10 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", 'warning');
            return false;
        }

        const jobData = {
            title: title, shopName: shopName, location: location, salary: salary,
            description: description, phone: phone, 
            timestamp: firebase.database.ServerValue.TIMESTAMP 
        };

        window.jobsRef.push(jobData) 
            .then(() => {
                displayMessage("‚úÖ ‡§ú‡•â‡§¨ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§π‡•ã ‡§ó‡§à ‡§π‡•à! ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶‡•§", 'success');
                form.reset(); 
                if(document.getElementById('jobs-screen').classList.contains('active')) loadJobs();
            })
            .catch((error) => {
                displayMessage("‚ùå ‡§ú‡•â‡§¨ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à: " + error.message, 'error', 7000);
                console.error("Firebase Job Error:", error);
            });

        return false;
    }
        
    window.onload = () => {
        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
             console.error("Firebase configuration is missing or invalid. Cannot initialize app.");
             document.getElementById('registrationScreen').innerHTML = "<h2>Configuration Error</h2><p>Firebase configuration is missing or invalid. Please check the settings.</p>";
             document.getElementById('registrationScreen').style.display = 'flex';
             return;
        }

        firebase.initializeApp(firebaseConfig);
        window.database = firebase.database();
        window.providersRef = database.ref('service_providers'); 
        window.jobsRef = database.ref('local_jobs'); 

        // 1. ‡§Ö‡§¶‡•É‡§∂‡•ç‡§Ø reCAPTCHA ‡§∏‡•á‡§ü‡§Ö‡§™
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible'
        });
        // reCAPTCHA ‡§∞‡•á‡§Ç‡§°‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à
        recaptchaVerifier.render().catch(e => console.error("reCAPTCHA Render Error:", e));

        // 2. ‡§™‡§∞‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§∏ ‡§ö‡•á‡§ï: ‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ë‡§•‡•á‡§Ç‡§ü‡§ø‡§ï‡•á‡§∂‡§® ‡§∏‡•ç‡§ü‡•á‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                document.getElementById('registrationScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex'; 
                console.log("Auto-Login Successful:", user.phoneNumber);

                startFirebaseListener();
                
            } else {
                document.getElementById('registrationScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§´‡§º‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§", 'info', 10000);
            }
        });


        // 3. ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§: OTP ‡§≠‡•á‡§ú‡•á‡§Ç (‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ü‡•á‡§™ 1)
        document.getElementById('sendOtpBtn').onclick = () => {
            const name = document.getElementById('userName').value.trim();
            const area = document.getElementById('userArea').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            
            if (!name || !area || phone.length !== 10 || isNaN(phone)) {
                displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° (‡§®‡§æ‡§Æ, ‡§è‡§∞‡§ø‡§Ø‡§æ) ‡§≠‡§∞‡•á‡§Ç ‡§î‡§∞ 10 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", 'warning');
                return;
            }

            tempUserData = {
                name: name,
                area: area,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            document.getElementById('sendOtpBtn').innerHTML = "Sending...";
            const fullPhone = '+91' + phone;
            displayMessage("OTP ‡§≠‡•á‡§ú‡§®‡•á ‡§ï‡•Ä ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...", 'info');

            // Force sign out (if any previous session exists) to ensure clean login
            firebase.auth().signOut()
                .then(() => initiateOtpFlow(fullPhone))
                .catch(() => initiateOtpFlow(fullPhone)); 

            function initiateOtpFlow(fullPhone) {
                // Ensure recaptcha is rendered before verification
                recaptchaVerifier.render().then(() => {
                    recaptchaVerifier.verify().then(() => {
                        displayMessage(`‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ú‡§æ‡§Å‡§ö ‡§™‡•Ç‡§∞‡•Ä ‡§π‡•Å‡§à‡•§ ${fullPhone} ‡§™‡§∞ OTP ‡§≠‡•á‡§ú‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...`, 'info', 5000);

                        firebase.auth().signInWithPhoneNumber(fullPhone, recaptchaVerifier)
                            .then((result) => {
                                confirmationResult = result;
                                document.getElementById('profileInputSection').style.display = 'none'; 
                                document.getElementById('otpSection').style.display = 'block'; 
                                displayMessage(`‚úÖ OTP ${fullPhone} ‡§™‡§∞ ‡§≠‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ!`, 'success');
                            })
                            .catch((err) => {
                                console.error("Firebase SMS Send Error:", err.code, err.message);
                                displayMessage(`‚ùå OTP ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞ ‡§Ü‡§à: ${err.message}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§`, 'error', 10000);
                                document.getElementById('sendOtpBtn').innerHTML = "Send OTP & Sign Up";
                                document.getElementById('profileInputSection').style.display = 'block';
                                document.getElementById('otpSection').style.display = 'none';
                                recaptchaVerifier.clear();
                            });
                    }).catch((err) => {
                        console.error("reCAPTCHA Verification Error:", err.message);
                        displayMessage(`‚ùå reCAPTCHA ‡§ú‡§æ‡§Å‡§ö ‡§Æ‡•á‡§Ç ‡§è‡§∞‡§∞: ${err.message}. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•á‡§ú ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡§ï‡•á ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç‡•§`, 'error', 10000);
                        document.getElementById('sendOtpBtn').innerHTML = "Send OTP & Sign Up";
                    });
                });
            }
        };


        // 4. OTP ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç (‡§≤‡•â‡§ó‡§ø‡§® ‡§∏‡•ç‡§ü‡•á‡§™ 2)
        document.getElementById('verifyOtpBtn').onclick = () => {
            const otp = document.getElementById('otpInput').value;
            if (otp.length !== 6) {
                displayMessage("‡§ï‡•É‡§™‡§Ø‡§æ 6 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ OTP ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", 'warning');
                return;
            }
            
            displayMessage("‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...", 'info');


            confirmationResult.confirm(otp)
                .then((result) => {
                    const user = result.user;
                    if (user && user.uid) {
                        window.database.ref('users/' + user.uid).set(tempUserData)
                            .then(() => {
                                displayMessage("‚úÖ Login Successful! Redirecting...", 'success');
                                location.reload(); 
                            })
                            .catch(error => {
                                console.error("Profile save error:", error);
                                displayMessage("Login Successful, but profile save failed. Please contact support.", 'error', 10000);
                            });
                    } else {
                        displayMessage("Verification Failed: User not returned.", 'error');
                    }
                })
                .catch((e) => {
                    console.error("OTP Confirmation Error:", e);
                    displayMessage("‚ùå ‡§ó‡§º‡§≤‡§§ OTP! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä 6 ‡§Ö‡§Ç‡§ï ‡§ï‡§æ OTP ‡§°‡§æ‡§≤‡•á‡§Ç‡•§", 'error', 5000);
                });
        };

        // ‡§è‡§ï‡•ç‡§∏‡•ç‡§ü‡•ç‡§∞‡§æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
        window.contactForAds = () => window.open('https://wa.me/919889904191?text=Hello! Main apne business ka ad lagwana chahta hoon Fatehpur Hubs pe', '_blank');
        window.shareApp = () => navigator.share ? navigator.share({title: 'Fatehpur Hubs', text: 'Best local services app', url: 'https://www.fatehpurhubs.co.in'}) : displayMessage('Share link: https://www.fatehpurhubs.co.in (‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç)', 'info', 5000);
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // ‡§ï‡•á‡§µ‡§≤ ‡§§‡§≠‡•Ä ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§ú‡§¨ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á
            if(id === 'jobs-screen') loadJobs();
            if(id === 'home-screen') loadCategories(); 
        };
        // PWA ‡§∏‡•á‡§ü‡§Ö‡§™
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // service worker registration logic goes here
            });
        }
    };
    </script>
</body>
</html>

