<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatehpur Hubs</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff6666">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial; }
        body { background: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; min-height: 100vh; }
        header { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 15px; text-align: center; }
        .screen { display: none; padding: 15px; }
        .screen.active { display: block; }
        #main-search-bar { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 25px; margin: 10px 0 20px; }
        .categories-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .cat-btn { background: white; border: 2px solid #e0e0e0; padding: 12px 8px; border-radius: 10px; cursor: pointer; text-align: center; font-size: 14px; transition: all 0.3s; }
        .cat-btn.selected { background: #2a5298; color: white; border-color: #2a5298; }
        .profile-card { background: white; border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .contact-btn, .whatsapp-btn, .share-btn-inline { padding: 8px 15px; border-radius: 20px; cursor: pointer; margin: 5px; }
        .contact-btn { background: #2a5298; color: white; border: none; }
        .whatsapp-btn { background: #25D366; color: white; border: none; }
        .share-btn-inline { background: #f8f9fa; color: #333; border: 1px solid #e0e0e0; }
        .footer { position: fixed; bottom: 0; width: 100%; max-width: 400px; background: white; padding: 10px 15px; display: flex; justify-content: space-between; border-top: 1px solid #e0e0e0; z-index: 100; }
        .premium-btn { background: #ffd700; color: #333; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; }
        .ad-container { margin: 15px 0; text-align: center; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .promotion-banner { background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; padding: 15px; border-radius: 12px; text-align: center; margin: 20px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div class="ad-container">
        <script type="text/javascript">
            atOptions = { 'key' : '969a80a2e6bea9f00173f36024f32cb2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
            document.write('<script type="text/javascript" src="//www.highperformanceformat.com/969a80a2e6bea9f00173f36024f32cb2/invoke.js"><\/script>');
        </script>
    </div>

    <div id="loginScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1e3c72,#2a5298);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:white;padding:40px 30px;border-radius:20px;text-align:center;width:90%;max-width:400px;">
            <h2 style="color:#1e3c72;">Fatehpur Hubs</h2>
            <p style="color:#555;margin:15px 0;">10 digit number daaliye</p>
            <input type="tel" id="phoneInput" placeholder="9876543210" maxlength="10" style="width:100%;padding:15px;margin:10px 0;border-radius:10px;border:1px solid #ddd;font-size:16px;">
            <button id="sendOtpBtn" style="width:100%;padding:15px;background:#25D366;color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;">Send OTP</button>
            <div id="otpSection" style="margin-top:20px;display:none;">
                <input type="text" id="otpInput" placeholder="123456" maxlength="6" style="width:100%;padding:15px;margin:10px 0;border-radius:10px;border:1px solid #ddd;font-size:16px;">
                <button id="verifyOtpBtn" style="width:100%;padding:15px;background:#ff9800;color:white;border:none;border-radius:10px;font-size:16px;cursor:pointer;">Verify OTP</button>
            </div>
            <p id="loginMsg" style="margin-top:15px;color:red;font-size:14px;min-height:20px;"></p>
            <div id="recaptcha-container"></div>
        </div>
    </div>

    <div class="container" id="mainApp" style="display:none;">
        <header><h1><img src="file_0000000059806208b25eb7951e979b96.png" alt="Logo" style="height:50px;"> Fatehpur Hubs</h1></header>

        <div id="home-screen" class="screen active">
            <input type="text" id="main-search-bar" placeholder="Search Plumber, Electrician..." onkeyup="searchServices()">

            <div class="promotion-banner">
                <p>Apna Business Promote Karein! ₹500/month se shuru<br>
                <button onclick="contactForAds()" style="background:white;color:#d35400;padding:8px 20px;border:none;border-radius:25px;margin-top:10px;font-weight:bold;">Ad Lagwayein</button></p>
            </div>

            <div class="ad-container">
                <script type="text/javascript">
                    atOptions = { 'key' : 'd65603602583bbe6bc3308e8ee8ab792', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
                    document.write('<script type="text/javascript" src="//www.highperformanceformat.com/d65603602583bbe6bc3308e8ee8ab792/invoke.js"><\/script>');
                </script>
            </div>

            <div class="promotion-section" style="margin:20px 0;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden;">
                <h3 style="text-align:center;color:white;font-size:18px;margin:0 0 15px;font-weight:bold;">
                    Special Offers & Promotions
                </h3>
                <div id="promotion-banner-area" style="position:relative;border-radius:12px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.3);">
                    <p style="text-align:center;color:#fff;padding:20px;font-size:14px;">Loading amazing offers...</p>
                </div>
                <div style="text-align:center;margin-top:15px;">
                    <button onclick="contactForAds()" style="background:#fff;color:#764ba2;padding:10px 25px;border:none;border-radius:30px;font-weight:bold;box-shadow:0 5px 15px rgba(0,0,0,0.2);">
                        Apna Ad Lagwayein (₹500/month)
                    </button>
                </div>
            </div>

            <h3>Popular Services</h3>
            <div class="categories-list" id="mistri-categories"></div>
            <div id="service-registration" style="margin:20px 0;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;color:white;">
                <h3 style="text-align:center;">Add Your Service</h3>
                <form id="serviceForm" onsubmit="event.preventDefault(); return registerService();">
                    <input type="text" id="providerName" placeholder="Your Name" required style="width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;">
                    <input type="tel" id="providerPhone" placeholder="Phone Number" required style="width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;">
                    <select id="serviceCategory" required style="width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;">
                        <option value="">Select Service</option>
                        <option>Plumber</option><option>Electrician</option><option>Carpenter</option><option>Mason</option>
                        <option>Painter</option><option>AC Mechanic</option><option>Tiler</option><option>Beautician</option>
                        <option>Home Cleaning</option><option>Security Guard</option><option>Laundry Service</option>
                        <option>Legal Consultant</option><option>Private Teacher</option><option>Computer Repair</option><option>Welder</option>
                    </select>
                    <input type="text" id="providerArea" placeholder="Your Area" required style="width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;">
                    <input type="text" id="providerExperience" placeholder="Experience (years)" required style="width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;">
                    <button type="submit" style="width:100%;background:#25D366;color:white;padding:12px;border:none;border-radius:8px;font-weight:bold;">Register Service</button>
                </form>
            </div>

            <div id="mistri-list"><h3>Available Services</h3><p style="text-align:center;color:#2a5298;">Loading...</p></div>
            <div style="height:80px;"></div>
        </div>

        <div id="jobs-screen" class="screen">
            <button onclick="showScreen('home-screen')" style="background:#f8f9fa;border:1px solid #ccc;padding:8px 15px;border-radius:5px;margin-bottom:15px;cursor:pointer;">Back</button>
            <h2>Local Jobs</h2>
            <div id="jobs-list"><p>Loading jobs...</p></div>
        </div>

        <div class="footer">
            <a href="https://rzp.io/rzp/4kK9deS" target="_blank" class="premium-btn">Go Premium</a>
            <button class="share-btn-inline" onclick="shareApp()">Share App</button>
            <button class="share-btn-inline" onclick="showScreen('jobs-screen')">Jobs</button>
        </div>
    </div>

    <div id="bottom-ad">
        <script type="text/javascript">
            atOptions = { 'key' : '969a80a2e6bea9f00173f36024f32cb2', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
            document.write('<script type="text/javascript" src="//www.highperformanceformat.com/969a80a2e6bea9f00173f36024f32cb2/invoke.js"><\/script>');
        </script>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="ads.js"></script>
    <script src="script.js"></script>
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyA37JsLUIG-kypZ55vdpLTp3WKHgRH2IwY",
        authDomain: "fatehpur-hubs-a3a9f.firebaseapp.com",
        databaseURL: "https://fatehpur-hubs-a3a9f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "fatehpur-hubs-a3a9f",
        storageBucket: "fatehpur-hubs-a3a9f.appspot.com",
        messagingSenderId: "294360741451",
        appId: "1:294360741451:web:3bc85078805750b9fabfce"
    };

    let recaptchaVerifier, confirmationResult;
    let isAppInitialized = false; 

    // Function to load the main app components
    function loadMainApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';

        if (!isAppInitialized) {
            // All required functions from script.js are called only ONCE here
            if (typeof startFirebaseListener === 'function') startFirebaseListener();
            if (typeof loadCategories === 'function') loadCategories();
            if (typeof loadPromotionAds === 'function') {
                loadPromotionAds();
                setTimeout(loadPromotionAds, 2000);
            }
            isAppInitialized = true;
        }
    }

    // ⭐ NEW: This function handles both login check and app load ⭐
    function handleSuccessfulLogin(user) {
        // We use the phone number from the Firebase Auth object
        const phone = user.phoneNumber; 
        
        // 1. Check if the user is registered in the Realtime Database
        checkIfUserExists(phone)
            .then(userFound => {
                if(userFound) {
                    loadMainApp();
                } else {
                    // Scenario: User is logged into Firebase Auth but not in your DB
                    // (Should not happen in your flow, but good to handle)
                    console.warn("User logged in but not found in DB. Should proceed to registration if required.");
                    loadMainApp(); 
                }
            })
            .catch(err => {
                console.error("Database check failed, loading main app anyway:", err);
                loadMainApp();
            });
    }

    function openWhatsApp(phone) {
        let num = phone.toString().replace(/[^0-9]/g, '');
        if (num.length === 10) num = '91' + num;
        if (num.length === 12 && num.startsWith('91')) {
            // perfect
        } else if (num.length === 13 && num.startsWith('919')) {
            num = num.substring(1);
        }
        window.open('https://wa.me/' + num, '_blank');
    }

    function registerService() {
        const name = document.getElementById('providerName').value;
        const phone = document.getElementById('providerPhone').value; // 10 digit number
        const category = document.getElementById('serviceCategory').value;
        const area = document.getElementById('providerArea').value;
        const experience = document.getElementById('providerExperience').value;
        const form = document.getElementById('serviceForm');

        if (!name || !phone || !category || !area || !experience || phone.length !== 10 || isNaN(phone)) {
            alert("कृपया सभी फ़ील्ड भरें और 10 अंक का सही फ़ोन नंबर डालें।");
            return false;
        }

        const providerData = {
            name: name,
            phone: phone, 
            category: category,
            area: area,
            experience: experience + ' years',
            timestamp: firebase.database.ServerValue.TIMESTAMP 
        };

        window.providersRef.push(providerData)
            .then(() => {
                alert("✅ सर्विस सफलतापूर्वक रजिस्टर हो गई है! धन्यवाद।");
                form.reset(); 
            })
            .catch((error) => {
                alert("❌ रजिस्ट्रेशन में एरर आई: " + error.message);
                console.error("Firebase Error:", error);
            });

        return true; 
    }
    
    function checkIfUserExists(phoneNumber) {
        // Accepts full number (+91XXXXXXXXXX) or 10-digit number
        const phoneNumForSearch = phoneNumber.startsWith('+91') ? phoneNumber.substring(3) : phoneNumber; 
        
        return new Promise((resolve, reject) => {
            if (!window.providersRef) return reject(new Error("Database not ready."));
            
            window.providersRef.orderByChild('phone').equalTo(phoneNumForSearch).limitToFirst(1).once('value')
                .then((snapshot) => {
                    resolve(snapshot.exists()); 
                })
                .catch(reject);
        });
    }

    window.onload = () => {
        // 0. INITIALIZE FIREBASE
        firebase.initializeApp(firebaseConfig);
        window.database = firebase.database();
        window.providersRef = database.ref('service_providers');
        window.jobsRef = database.ref('local_jobs');
        
        // 1. **CRITICAL FIX FOR PERSISTENCE:** Auto-Login Check runs FIRST
        firebase.auth().onAuthStateChanged(user => {
            if (user && !isAppInitialized) {
                // If a user is found AND the app hasn't been initialized yet
                handleSuccessfulLogin(user);
            }
        });

        // INVISIBLE reCAPTCHA
        recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
            'size': 'invisible'
        });
        recaptchaVerifier.render();

        // 2. SEND OTP (Billing Optimized)
        document.getElementById('sendOtpBtn').onclick = () => {
            const rawPhone = document.getElementById('phoneInput').value.trim();
            const fullPhone = '+91' + rawPhone;
            
            if (rawPhone.length !== 10) {
                document.getElementById('loginMsg').innerHTML = "10 digit daaliye";
                return;
            }
            
            document.getElementById('sendOtpBtn').innerHTML = "Checking...";
            document.getElementById('sendOtpBtn').disabled = true; 
            document.getElementById('loginMsg').innerHTML = ""; 
            
            // Check if user exists before sending OTP (Billing optimization)
            checkIfUserExists(rawPhone) // Pass 10-digit number for DB check
                .then((userFound) => {
                    if (userFound) {
                        // If user is found in DB, skip OTP and try to sign in silently
                        document.getElementById('loginMsg').innerHTML = "<span style='color:orange'>User found. Signing in...</span>";

                        // This ensures that even if persistence failed, we try to log them in again
                        firebase.auth().signInWithPhoneNumber(fullPhone, recaptchaVerifier)
                            .then(result => {
                                // If the session is still active, this might complete quickly
                                if (result && result.user) {
                                     handleSuccessfulLogin(result.user);
                                } else {
                                    // Need OTP
                                    confirmationResult = result;
                                    document.getElementById('otpSection').style.display = 'block';
                                    document.getElementById('sendOtpBtn').style.display = 'none';
                                    document.getElementById('loginMsg').innerHTML = "<span style='color:green'>OTP bheja gaya!</span>";
                                }
                            })
                            .catch((err) => {
                                // If silent sign-in fails, proceed to normal OTP flow
                                document.getElementById('sendOtpBtn').innerHTML = "Sending...";
                                firebase.auth().signInWithPhoneNumber(fullPhone, recaptchaVerifier)
                                    .then((result) => {
                                        confirmationResult = result;
                                        document.getElementById('otpSection').style.display = 'block';
                                        document.getElementById('sendOtpBtn').style.display = 'none';
                                        document.getElementById('loginMsg').innerHTML = "<span style='color:green'>OTP bheja gaya!</span>";
                                    })
                                    .catch((err) => {
                                        document.getElementById('loginMsg').innerHTML = err.message;
                                        document.getElementById('sendOtpBtn').innerHTML = "Send OTP";
                                        document.getElementById('sendOtpBtn').disabled = false;
                                    });
                            });
                        return;
                    }

                    // If new user, proceed with OTP
                    document.getElementById('sendOtpBtn').innerHTML = "Sending...";
                    
                    recaptchaVerifier.verify().then(() => {
                        firebase.auth().signInWithPhoneNumber(fullPhone, recaptchaVerifier)
                            .then((result) => {
                                confirmationResult = result;
                                document.getElementById('otpSection').style.display = 'block';
                                document.getElementById('sendOtpBtn').style.display = 'none';
                                document.getElementById('loginMsg').innerHTML = "<span style='color:green'>OTP bheja gaya!</span>";
                            })
                            .catch((err) => {
                                document.getElementById('loginMsg').innerHTML = err.message;
                                document.getElementById('sendOtpBtn').innerHTML = "Send OTP";
                                document.getElementById('sendOtpBtn').disabled = false;
                            });
                    })
                    .catch((err) => {
                         document.getElementById('loginMsg').innerHTML = "Recaptcha Error: " + err.message;
                         document.getElementById('sendOtpBtn').innerHTML = "Send OTP";
                         document.getElementById('sendOtpBtn').disabled = false;
                    });

                })
                .catch((error) => {
                    document.getElementById('loginMsg').innerHTML = "Error checking user: " + error.message;
                    document.getElementById('sendOtpBtn').innerHTML = "Send OTP";
                    document.getElementById('sendOtpBtn').disabled = false;
                });
        };

        // 3. VERIFY OTP (Persistence Added)
        document.getElementById('verifyOtpBtn').onclick = () => {
            const otp = document.getElementById('otpInput').value;
            
            // Set persistence to LOCAL before confirming OTP (Ensures long-term session)
            firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    return confirmationResult.confirm(otp);
                })
                .then(result => {
                    handleSuccessfulLogin(result.user);
                })
                .catch((error) => {
                    document.getElementById('loginMsg').innerHTML = "Galat OTP या एरर: " + error.message;
                    console.error(error);
                });
        };

        // Extra functions
        window.contactForAds = () => window.open('https://wa.me/919889904191?text=Hello! Main apne business ka ad lagwana chahta hoon Fatehpur Hubs pe', '_blank');
        window.shareApp = () => navigator.share ? navigator.share({title: 'Fatehpur Hubs', text: 'Best local services app', url: 'https://www.fatehpurhubs.co.in'}) : alert('Share link: https://www.fatehpurhubs.co.in');
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'jobs-screen' && typeof loadJobs === 'function') loadJobs();
        };
        // PWA setup
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('SW Error:', err));
            });
        }
    };
    </script>
    </body>
    </html>
