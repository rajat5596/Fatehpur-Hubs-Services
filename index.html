<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatehpur Hubs</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff6666">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial}
        body{background:#f5f5f5}
        .container{max-width:400px;margin:0 auto;background:white;min-height:100vh;padding-bottom:100px}
        header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:15px;text-align:center}
        .screen{display:none;padding:15px}
        .screen.active{display:block}
        .categories-list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:20px}
        .cat-btn{background:white;border:2px solid #e0e0e0;padding:12px;border-radius:10px;cursor:pointer;text-align:center;font-size:14px;transition:.3s}
        .cat-btn.selected{background:#2a5298;color:white;border-color:#2a5298}
        .profile-card{background:white;border:1px solid #e0e0e0;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .contact-btn,.whatsapp-btn,.share-btn-inline{padding:8px 15px;border-radius:20px;cursor:pointer;border:none}
        .contact-btn{background:#2a5298;color:white}
        .whatsapp-btn{background:#25D366;color:white}
        .share-btn-inline{background:#f8f9fa;color:#333;border:1px solid #e0e0e0}
        .footer{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);width:100%;max-width:400px;background:white;padding:10px;display:flex;justify-content:space-around;border-top:1px solid #e0e0e0;z-index:1000}
        .premium-btn{background:#ffd700;color:#333;padding:8px 15px;border-radius:20px;text-decoration:none;font-weight:bold}
        .ad-container{margin:15px 0;text-align:center;background:#f8f9fa;padding:10px;border-radius:8px;border:1px solid #e0e0e0}
        .reg-input{width:100%;padding:15px;margin:10px 0;border-radius:10px;border:1px solid #ddd;font-size:16px}
        #bottom-ad{position:fixed;bottom:0;width:100%;max-width:400px;height:50px;background:#f5f5f5;display:flex;justify-content:center;align-items:center;z-index:999}
        .load-more-btn{width:100%;padding:15px;background:#2a5298;color:white;border:none;border-radius:10px;font-weight:bold;margin:20px 0;cursor:pointer}
    </style>
</head>
<body>

<div class="ad-container">
    <script type="text/javascript">
        atOptions = {'key':'969a80a2e6bea9f00173f36024f32cb2','format':'iframe','height':50,'width':320,'params':{}};
        document.write('<script type="text/javascript" src="//www.highperformanceformat.com/969a80a2e6bea9f00173f36024f32cb2/invoke.js"><\/script>');
    </script>
</div>

<!-- Login Screen -->
<div id="registrationScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1e3c72,#2a5298);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:white;padding:30px;border-radius:20px;text-align:center;width:90%;max-width:400px;">
        <h2 style="color:#1e3c72;margin-bottom:20px;">Fatehpur Hubs</h2>
        <div id="profileInputSection">
            <input type="text" id="userName" placeholder="आपका नाम" class="reg-input">
            <input type="text" id="userArea" placeholder="आपका इलाका" class="reg-input">
            <input type="tel" id="phoneInput" placeholder="10 अंक का मोबाइल" maxlength="10" class="reg-input">
            <button id="sendOtpBtn" style="width:100%;padding:15px;background:#25D366;color:white;border:none;border-radius:10px;margin-top:15px;cursor:pointer;">Send OTP & Login</button>
        </div>
        <div id="otpSection" style="display:none;margin-top:20px;">
            <input type="text" id="otpInput" placeholder="6 अंक का OTP" maxlength="6" class="reg-input">
            <button id="verifyOtpBtn" style="width:100%;padding:15px;background:#ff9800;color:white;border:none;border-radius:10px;margin-top:10px;">Verify OTP</button>
        </div>
        <p id="loginMsg" style="color:red;margin-top:15px;min-height:25px;"></p>
        <div id="recaptcha-container"></div>
    </div>
</div>

<div class="container" id="mainApp" style="display:none;">
    <header><h1>Fatehpur Hubs</h1></header>

    <div id="home-screen" class="screen active">
        <div class="categories-list" id="mistri-categories"></div>
        
        <div id="service-registration" style="margin:20px 0;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:10px;color:white;">
            <h3 style="text-align:center;">अपनी सर्विस रजिस्टर करें</h3>
            <form onsubmit="event.preventDefault(); registerService();">
                <input type="text" id="providerName" placeholder="नाम" required class="reg-input" style="background:white;color:black;">
                <input type="tel" id="providerPhone" placeholder="मोबाइल" required class="reg-input" style="background:white;color:black;">
                <select id="serviceCategory" required class="reg-input" style="background:white;color:black;">
                    <option value="">सर्विस चुनें</option>
                    <option>Plumber</option><option>Electrician</option><option>Carpenter</option><option>Mason</option><option>Painter</option>
                    <option>AC Mechanic</option><option>Tiler</option><option>Beautician</option><option>Home Cleaning</option>
                    <option>Security Guard</option><option>Laundry Service</option><option>Legal Consultant</option>
                    <option>Private Teacher</option><option>Computer Repair</option><option>Welder</option>
                </select>
                <input type="text" id="providerArea" placeholder="इलाका" required class="reg-input" style="background:white;color:black;">
                <input type="text" id="providerExperience" placeholder="अनुभव (साल में)" required class="reg-input" style="background:white;color:black;">
                <button type="submit" style="width:100%;padding:15px;background:#25D366;color:white;border:none;border-radius:10px;margin-top:10px;">Register</button>
            </form>
        </div>

        <div id="mistri-list"></div>
        <button id="load-more-providers" class="load-more-btn" style="display:none;">Load More</button>
    </div>

    <div id="jobs-screen" class="screen">
        <button onclick="showScreen('home-screen')" style="margin-bottom:20px;padding:10px;background:#f0f0f0;">← Home</button>
        <h2>Local Jobs</h2>
        <div id="jobs-list"><p>Loading...</p></div>
    </div>

    <div class="footer">
        <a href="https://rzp.io/rzp/4kK9deS" target="_blank" class="premium-btn">Go Premium</a>
        <button class="share-btn-inline" onclick="shareApp()">Share</button>
        <button class="share-btn-inline" onclick="showScreen('jobs-screen')">Jobs</button>
    </div>
</div>

<div id="bottom-ad">
    <script type="text/javascript">
        atOptions = {'key':'969a80a2e6bea9f00173f36024f32cb2','format':'iframe','height':50,'width':320,'params':{}};
        document.write('<script type="text/javascript" src="//www.highperformanceformat.com/969a80a2e6bea9f00173f36024f32cb2/invoke.js"><\/script>');
    </script>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyA37JsLUIG-kypZ55vdpLTp3WKHgRH2IwY",
    authDomain: "fatehpur-hubs-a3a9f.firebaseapp.com",
    databaseURL: "https://fatehpur-hubs-a3a9f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "fatehpur-hubs-a3a9f",
    storageBucket: "fatehpur-hubs-a3a9f.appspot.com",
    messagingSenderId: "294360741451",
    appId: "1:294360741451:web:3bc85078805750b9fabfce"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const providersRef = db.ref('service_providers');
const jobsRef = db.ref('local_jobs');

let recaptchaVerifier, confirmationResult;
let lastTimestamp = null;
let currentCategory = null;
let filtered = [];
let page = 0;
const limit = 20;

function renderCard(p){return `<div class="profile-card"><h4 style="color:#2a5298">${p.name} - (${p.category})</h4><p style="font-size:12px;color:#555">${p.area} | ${p.experience}</p><div style="margin-top:10px;display:flex;gap:5px;"><button class="whatsapp-btn" onclick="openWhatsApp('${p.phone}')">WhatsApp</button><button class="contact-btn" onclick="location.href='tel:${p.phone}'">Call</button></div></div>`;}

function renderCategories(){
    const cats = ['Plumber','Electrician','Carpenter','Mason','Painter','AC Mechanic','Tiler','Beautician','Home Cleaning','Security Guard','Laundry Service','Legal Consultant','Private Teacher','Computer Repair','Welder'];
    document.getElementById('mistri-categories').innerHTML = cats.map(c=>`<button class="cat-btn" onclick="filterCategory('${c}')">${c}</button>`).join('');
}

window.loadServices = (more=false)=>{
    const list = document.getElementById('mistri-list');
    const btn = document.getElementById('load-more-providers');
    btn.style.display='none';
    if(!more){lastTimestamp=null;currentCategory=null;document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('selected'));list.innerHTML='<h3>All Services</h3><p style="text-align:center">Loading...</p>';}
    let q = providersRef.orderByChild('timestamp').limitToLast(more?limit:limit+1);
    if(more && lastTimestamp) q = providersRef.orderByChild('timestamp').endBefore(lastTimestamp).limitToLast(limit+1);
    q.once('value',s=>{
        let items=[]; s.forEach(c=>items.push(c.val())); items.reverse();
        if(more && items.length>limit) items.shift();
        if(items.length>0) lastTimestamp = items[items.length-1].timestamp;
        const html = items.map(renderCard).join('');
        if(more) list.insertAdjacentHTML('beforeend',html); else list.innerHTML='<h3>All Services</h3>'+html;
        if(s.numChildren()>limit || more){btn.style.display='block';btn.onclick=()=>loadServices(true);}
    });
};

window.filterCategory = (cat, more=false)=>{
    const list = document.getElementById('mistri-list');
    const btn = document.getElementById('load-more-providers');
    document.querySelectorAll('.cat-btn').forEach(b=>b.classList.toggle('selected',b.innerText===cat));
    currentCategory=cat; page=0; filtered=[];
    if(!more) list.innerHTML=`<h3>${cat}</h3><p style="text-align:center">Loading...</p>`;
    providersRef.orderByChild('category').equalTo(cat).once('value',s=>{
        s.forEach(c=>filtered.push(c.val()));
        filtered.sort((a,b)=>b.timestamp-a.timestamp);
        showPage(more);
    });
    function showPage(m){const start=m?page*limit:0; const items=filtered.slice(start,start+limit); list.insertAdjacentHTML('beforeend',items.map(renderCard).join('')); page++;
        if(start+limit < filtered.length){btn.style.display='block';btn.onclick=()=>filterCategory(cat,true);}else btn.style.display='none';
    }
};

function registerService(){
    const name=document.getElementById('providerName').value.trim();
    const phone=document.getElementById('providerPhone').value.trim();
    const cat=document.getElementById('serviceCategory').value;
    const area=document.getElementById('providerArea').value.trim();
    const exp=document.getElementById('providerExperience').value.trim();
    if(!name||!phone||!cat||!area||!exp) return alert("सभी भरें");
    if(phone.length!==10) return alert("10 अंक");
    providersRef.orderByChild('phone').equalTo(phone).once('value',s=>{
        if(s.exists()){let old; s.forEach(c=>old=c.val()); alert(`पहले से है!\n${old.name} - ${old.category} - ${old.area}`); return;}
        providersRef.push({name,phone,category:cat,area,experience:exp+' years',timestamp:firebase.database.ServerValue.TIMESTAMP}).then(()=>{alert("हो गया!");document.getElementById('serviceForm').reset(); currentCategory?filterCategory(currentCategory):loadServices();});
    });
}

function openWhatsApp(p){p=p.replace(/\D/g,'');if(p.length==10)p='91'+p;open('https://wa.me/'+p,'_blank');}
function shareApp(){navigator.share?navigator.share({title:'Fatehpur Hubs',url:location.href}):alert(location.href);}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='home-screen')loadServices();}

document.getElementById('sendOtpBtn').onclick=()=>{
    const name=document.getElementById('userName').value.trim();
    const area=document.getElementById('userArea').value.trim();
    const phone=document.getElementById('phoneInput').value.trim();
    if(!name||!area||phone.length!==10){document.getElementById('loginMsg').innerHTML='<span style="color:red">सब भरें</span>';return;}
    document.getElementById('sendOtpBtn').disabled=true;
    recaptchaVerifier.verify().then(()=>firebase.auth().signInWithPhoneNumber('+91'+phone,recaptchaVerifier).then(r=>{
        confirmationResult=r;
        document.getElementById('profileInputSection').style.display='none';
        document.getElementById('otpSection').style.display='block';
        document.getElementById('loginMsg').innerHTML='<span style="color:green">OTP भेजा!</span>';
    }).catch(e=>{document.getElementById('loginMsg').innerHTML='<span style="color:red">'+e.message+'</span>';document.getElementById('sendOtpBtn').disabled=false;}));
};

document.getElementById('verifyOtpBtn').onclick=()=>{
    const otp=document.getElementById('otpInput').value;
    if(otp.length!==6) return document.getElementById('loginMsg').innerHTML='<span style="color:red">6 अंक</span>';
    confirmationResult.confirm(otp).then(()=>location.reload()).catch(()=>document.getElementById('loginMsg').innerHTML='<span style="color:red">गलत OTP</span>');
};

window.onload=()=>{
    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'invisible'});
    recaptchaVerifier.render();
    firebase.auth().onAuthStateChanged(u=>{
        if(u){
            document.getElementById('registrationScreen').style.display='none';
            document.getElementById('mainApp').style.display='block';
            renderCategories();
            loadServices();
        }else{
            document.getElementById('registrationScreen').style.display='flex';
        }
    });
};
</script>
</body>
</html>
